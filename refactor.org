#+TITLE: renderer.go Refactoring Guide
#+AUTHOR: Development Team
#+DATE: 2024-12-02
#+STARTUP: overview

* Overview

This document provides a guide for refactoring ~renderer.go~ (2377 lines) into smaller,
focused files. The pattern follows the successful refactoring of ~layout.go~ which was
split into 9 smaller files.

** Refactoring Principles

1. *Same Package*: All files remain in ~package ui~ - they share access to unexported types
2. *Single Responsibility*: Each file has one clear purpose
3. *Minimal Churn*: Only move code, don't change function signatures
4. *Preserve Imports*: Each new file only includes imports it needs
5. *Build After Each Step*: Run ~go build ./...~ after each file extraction

** Current Structure Analysis

| Lines     | Content                                      | Target File           |
|-----------+----------------------------------------------+-----------------------|
| 1-39      | Package declaration, imports                 | renderer.go (keep)    |
| 41-107    | UIAction enum and constants                  | types.go              |
| 109-482   | Type definitions (structs, enums)            | types.go              |
| 484-531   | parseDirectivesForDisplay, DetectedDirective | types.go              |
| 533-764   | Color constants, Renderer struct             | colors.go + renderer.go |
| 765-809   | NewRenderer()                                | renderer.go (keep)    |
| 810-904   | Setter methods (SetShowDotfiles, etc.)       | renderer_setters.go   |
| 905-978   | Tab management (EnableTabs, AddTab, etc.)    | renderer_tabs.go      |
| 979-1171  | Preview (ShowPreview, loadImage/Text, Hide)  | renderer_preview.go   |
| 1172-1271 | Theme, dialogs, rename, multi-select         | renderer.go (keep)    |
| 1273-1315 | collectSelectedPaths, onLeftClick, ButtonStyle | renderer.go (keep)  |
| 1318-1493 | UI helpers (styledButton, modal*, separators) | renderer.go (keep)   |
| 1495-1786 | Input handling (detectRightClick, processGlobalInput, buildHotkeyFilters) | renderer_input.go |
| 1789-2003 | Column rendering (renderColumns)             | renderer_rows.go      |
| 2006-2331 | Row rendering (renderRow, renderRowContent, renderFavoriteRow, renderDriveRow) | renderer_rows.go |
| 2334-2377 | Utility functions (formatSize, truncatePathMiddle) | renderer.go (keep) |

* Phase 1: Create types.go (~500 lines)

Extract all type definitions to a dedicated file.

** Content to Move

#+begin_src go
// types.go
package ui

// Lines 41-107: UIAction enum
type UIAction int

const (
    ActionNone UIAction = iota
    ActionNavigate
    // ... all action constants through ActionOpenTerminal
)

// Lines 109-114: ClipOp
type ClipOp int

const (
    ClipCopy ClipOp = iota
    ClipCut
)

// Lines 116-170: Info structs
type SearchEngineInfo struct { ... }
type TerminalInfo struct { ... }
type ConflictResolution int
const ( ConflictAsk ... )
type ConflictState struct { ... }
type BrowserTab struct { ... }
type BreadcrumbSegment struct { ... }

// Lines 172-267: parseBreadcrumbSegments function

// Lines 269-398: ResizeHandle and related types
type ResizeHandle struct { ... }
type ResizeHandleStyle struct { ... }
func DefaultResizeHandleStyle() ResizeHandleStyle { ... }
func (h *ResizeHandle) Layout(...) { ... }

// Lines 400-482: More type definitions
type SortColumn int
const ( SortByName ... )
type Clipboard struct { ... }
type UIEvent struct { ... }
type UIEntry struct { ... }
type FavoriteItem struct { ... }
type ProgressState struct { ... }
type DriveItem struct { ... }
type SearchHistoryItem struct { ... }
type DetectedDirective struct { ... }

// Lines 484-531: parseDirectivesForDisplay function
#+end_src

** Implementation Steps

1. Create ~internal/ui/types.go~
2. Add ~package ui~ and required imports (only: image, image/color, time, path/filepath, strings, gioui imports)
3. Move type definitions in order shown above
4. Remove moved content from renderer.go
5. Run ~go build ./...~

* Phase 2: Create colors.go (~50 lines)

Extract color constants.

** Content to Move

#+begin_src go
// colors.go
package ui

import "image/color"

// Theme colors - these are variables so they can be modified for dark mode
var (
    colWhite       = color.NRGBA{R: 255, G: 255, B: 255, A: 255}
    colBlack       = color.NRGBA{R: 0, G: 0, B: 0, A: 255}
    colGray        = color.NRGBA{R: 128, G: 128, B: 128, A: 255}
    colLightGray   = color.NRGBA{R: 224, G: 224, B: 224, A: 255}
    colSelected    = color.NRGBA{R: 232, G: 240, B: 254, A: 255}
    colSidebar     = color.NRGBA{R: 245, G: 245, B: 245, A: 255}
    colAccent      = color.NRGBA{R: 24, G: 119, B: 232, A: 255}
    colDirBlue     = color.NRGBA{R: 44, G: 98, B: 172, A: 255}
    colDanger      = color.NRGBA{R: 220, G: 53, B: 69, A: 255}
    // ... all color constants
)
#+end_src

** Implementation Steps

1. Create ~internal/ui/colors.go~
2. Move all ~col*~ variable declarations
3. Remove from renderer.go
4. Run ~go build ./...~

* Phase 3: Create renderer_setters.go (~100 lines)

Extract configuration setter methods.

** Content to Move (Lines 810-904)

#+begin_src go
// renderer_setters.go
package ui

// Configuration setters - methods to update renderer state from orchestrator

func (r *Renderer) SetShowDotfilesCheck(v bool)
func (r *Renderer) SetSearchEngine(engineID string)
func (r *Renderer) SetDefaultDepth(depth int)
func (r *Renderer) SetDarkMode(dark bool)
func (r *Renderer) SetTerminals(terminals []TerminalInfo)
func (r *Renderer) SetSelectedTerminal(terminalID string)
func (r *Renderer) SetConfigError(err string)
func (r *Renderer) SetSearchHistory(items []SearchHistoryItem)
func (r *Renderer) SetHotkeys(cfg config.HotkeysConfig)
func (r *Renderer) ShowSearchHistory()
func (r *Renderer) HideSearchHistory()
func (r *Renderer) SetSidebarTabStyle(style string)
func (r *Renderer) SetSidebarLayout(layout string)
func (r *Renderer) SetPreviewConfig(...)
#+end_src

** Implementation Steps

1. Create ~internal/ui/renderer_setters.go~
2. Move setter methods
3. Required import: ~github.com/justyntemme/razor/internal/config~
4. Run ~go build ./...~

* Phase 4: Create renderer_tabs.go (~80 lines)

Extract tab management methods.

** Content to Move (Lines 905-978)

#+begin_src go
// renderer_tabs.go
package ui

// Browser tab management

func (r *Renderer) EnableTabs(enabled bool)
func (r *Renderer) AddTab(id, title, path string) int
func (r *Renderer) CloseTab(index int) int
func (r *Renderer) SetActiveTab(index int)
func (r *Renderer) UpdateTabTitle(index int, title string)
func (r *Renderer) UpdateTabPath(index int, path string)
func (r *Renderer) GetActiveTabIndex() int
func (r *Renderer) GetTabCount() int
func (r *Renderer) TabsEnabled() bool
#+end_src

* Phase 5: Create renderer_preview.go (~200 lines)

Extract preview loading logic.

** Content to Move (Lines 979-1171)

#+begin_src go
// renderer_preview.go
package ui

import (
    "image"
    "os"
    "path/filepath"
    "strings"
    // image format imports
)

// File preview loading and state management

func (r *Renderer) ShowPreview(path string) error
func (r *Renderer) loadImagePreview(path string) error
func (r *Renderer) loadTextPreview(path, ext string) error
func (r *Renderer) HidePreview()
func (r *Renderer) IsPreviewVisible() bool
func (r *Renderer) SetRecentView(isRecent bool)
func (r *Renderer) IsRecentView() bool
#+end_src

* Phase 6: Create renderer_input.go (~300 lines)

Extract input handling logic.

** Content to Move (Lines 1495-1786)

#+begin_src go
// renderer_input.go
package ui

import (
    "gioui.org/io/event"
    "gioui.org/io/key"
    "gioui.org/io/pointer"
    "gioui.org/layout"
)

// Keyboard and mouse input handling

func invisibleClickable(gtx layout.Context, click *widget.Clickable, w layout.Widget) layout.Dimensions
func (r *Renderer) detectRightClick(gtx layout.Context, tag event.Tag) bool
func (r *Renderer) processGlobalInput(gtx layout.Context, state *State, keyTag event.Tag) UIEvent
func (r *Renderer) findNextMatchingEntry(state *State, letter rune) int
func (r *Renderer) buildHotkeyFilters(keyTag event.Tag) []event.Filter
#+end_src

* Phase 7: Create renderer_rows.go (~550 lines)

Extract row rendering logic.

** Content to Move (Lines 1789-2331)

#+begin_src go
// renderer_rows.go
package ui

import (
    "image"
    "image/color"
    "path/filepath"
    "strings"
    "gioui.org/..."
)

// File list row rendering - columns, rows, favorites, drives

func (r *Renderer) renderColumns(gtx layout.Context) (layout.Dimensions, UIEvent)
func (r *Renderer) renderRow(gtx layout.Context, item *UIEntry, ...) (...)
func (r *Renderer) renderRowContent(gtx layout.Context, item *UIEntry, ...) layout.Dimensions
func (r *Renderer) renderFavoriteRow(gtx layout.Context, fav *FavoriteItem) (...)
func (r *Renderer) renderDriveRow(gtx layout.Context, drive *DriveItem) (layout.Dimensions, bool)
#+end_src

* Remaining renderer.go (~650 lines)

After extraction, renderer.go should contain:

- Package declaration and imports
- Renderer struct definition
- NewRenderer() constructor
- Core state methods:
  - applyTheme()
  - ShowCreateDialog()
  - StartRename() / CancelRename()
  - ResetMultiSelect() / IsMultiSelectMode() / SetMultiSelectMode()
  - IsExpanded() / SetExpanded() / GetExpandedDirs() / ClearExpanded()
  - FocusSearch()
  - collectSelectedPaths()
  - onLeftClick()
- UI helper functions:
  - styledButton() / dialogButtonRow()
  - layoutHorizontalSeparator() / layoutHorizontalSeparatorMin() / layoutInsetSeparator() / layoutMenuSeparator()
  - drawXIcon()
  - modalBackdrop() / modalContent() / modalContentWithClose()
- Utility functions:
  - formatSize()
  - truncatePathMiddle()

* Implementation Checklist

Execute in order:

1. [ ] Create types.go (move type definitions)
2. [ ] Create colors.go (move color constants)
3. [ ] Create renderer_setters.go (move setter methods)
4. [ ] Create renderer_tabs.go (move tab methods)
5. [ ] Create renderer_preview.go (move preview methods)
6. [ ] Create renderer_input.go (move input handling)
7. [ ] Create renderer_rows.go (move row rendering)
8. [ ] Clean up renderer.go imports
9. [ ] Run ~go build ./...~
10. [ ] Run ~go test ./...~
11. [ ] Run ~go vet ./...~

* Verification

After each file extraction:

#+begin_src bash
go build ./...
go test ./...
go vet ./...
#+end_src

* Notes

** Import Management

Each new file should only include imports it uses. The original renderer.go has many imports;
distribute them appropriately:

| File                | Key Imports                                    |
|---------------------+------------------------------------------------|
| types.go            | image, image/color, time, filepath, strings, gioui (layout, widget, etc.) |
| colors.go           | image/color                                    |
| renderer_setters.go | config                                         |
| renderer_tabs.go    | (none special)                                 |
| renderer_preview.go | image, os, filepath, strings, image format decoders, goheif |
| renderer_input.go   | gioui/io/event, gioui/io/key, gioui/io/pointer |
| renderer_rows.go    | image, color, filepath, strings, gioui packages |

** Shared State

All files access the Renderer struct which remains in renderer.go. Since they're all
in ~package ui~, they have full access to unexported fields.
