#+TITLE: Razor File Manager - Project Status
#+AUTHOR: justyntemme
#+DATE: 2024

* Design Philosophies

** LLM Commandments
Rules that all LLMs should follow when working on this codebase:

1. *Always review Gio documentation before making assumptions about UI behavior*
   - Gio has specific patterns for event handling, layout, and rendering
   - Check https://gioui.org/doc/architecture for architectural patterns
   - Check https://pkg.go.dev/gioui.org for API documentation
   - Never assume how events propagate - verify with documentation

2. *Test incrementally with debug output*
   - When fixing UI issues, add debug statements to understand the problem
   - Verify assumptions with actual runtime output before proceeding

3. *Prefer Gio's built-in patterns over custom implementations*
   - Use widget.Clickable for click handling
   - Use event.Op and pointer.Filter for custom event handling
   - Avoid complex manual hit-testing when Gio's event system can handle it

4. *Understand Gio's immediate mode rendering*
   - Layout happens every frame
   - Event registration in frame N delivers events in frame N+1
   - State must be stored in the Renderer struct between frames

5. *Avoid over-abstraction*
   - Simple one-liners like strings.ToLower(filepath.Ext(path)) should NOT be wrapped in helper functions
   - Only create abstractions when they provide clear value (reduce duplication of complex logic)
   - Constants are acceptable for magic numbers that aid readability

* Current Priorities

** TODO Improve User Feedback (Error Handling)
- Critical errors currently go to log.Printf, invisible to GUI users
- Add ToastError(msg string) method to Renderer
- Show permission denied, file open failures, etc. to user

** TODO Windows Drive Enumeration Fix
- GetVolumeInformationW can block for seconds on disconnected network drives
- Freezes UI while waiting
- Move drive enumeration to background goroutine

** TODO Syntax Highlighting Module (internal/highlight)
Reusable code formatting module for preview pane and markdown code blocks.

*** Goals:
    - Single module provides formatting for multiple contexts
    - Preview pane uses it for raw code file display
    - Markdown renderer uses it for fenced code blocks
    - Extensible to support new languages easily

*** Libraries to evaluate:
    - github.com/alecthomas/chroma - Full-featured syntax highlighter
    - github.com/yuin/goldmark - Markdown parsing

** DONE Markdown Preview with Toggle
   CLOSED: [2024-11-30]
   - [X] Raw/Preview toggle button in preview pane header
   - [X] Parse markdown with goldmark (github.com/yuin/goldmark)
   - [X] Walk AST to build richtext spans
   - [X] Support: headings, bold, italic, code, lists, links, blockquotes
   - [X] Config setting for default render mode (markdownRendered)
   - [ ] Code blocks use Syntax Highlighting Module (future enhancement)

** TODO Recent Files View Improvements
- [ ] Apply search bar filtering to Recent Files entries
- [ ] Filter by filename as user types
- [ ] Maintain same search-as-you-type behavior as normal file list
- [ ] Disable paste in Recent Files view (no target directory to paste to)

* Critical Features for Explorer/Finder Parity

** Tier 1: Table Stakes (Must Have)

*** TODO Drag and Drop
    Priority: CRITICAL
    - [ ] Drag files to move
    - [ ] Drag to folders to move into
    - [ ] Ctrl/Cmd+drag to copy instead of move
    - [ ] Visual feedback during drag (ghost image, drop indicator)
    - [ ] Drag from external apps (e.g., browser downloads)
    - [ ] Drop to external apps
    Note: Previously on hold due to Gio challenges - needs investigation

*** TODO Multi-Select Improvements
    Priority: CRITICAL
    - [ ] Shift+click for range selection
    - [ ] Ctrl/Cmd+click for toggle selection
    - [ ] Ctrl/Cmd+A to select all
    - [ ] Click empty space to deselect all
    - [ ] Selection count in status bar

*** TODO Breadcrumb Path Bar
    Priority: HIGH
    - [ ] Display path as clickable segments (Home > Documents > Projects)
    - [ ] Click any segment to navigate to that directory
    - [ ] Right-click segment for context menu (copy path, open in new tab)
    - [ ] Overflow handling for long paths (collapse middle segments)

*** TODO Progress Dialogs for File Operations
    Priority: HIGH
    - [ ] Progress bar for copy/move operations
    - [ ] Show source, destination, current file
    - [ ] Time remaining estimate
    - [ ] Cancel button
    - [ ] Pause/Resume (stretch goal)
    - [ ] Handle conflicts (skip, replace, rename)

*** TODO Undo/Redo File Operations
    Priority: HIGH
    - [ ] Undo stack for delete, move, rename, copy
    - [ ] Ctrl/Cmd+Z to undo last operation
    - [ ] Ctrl/Cmd+Shift+Z to redo
    - [ ] Operation history viewer (stretch goal)

*** TODO Trash/Recycle Bin Integration
    Priority: HIGH
    - [ ] Delete moves to trash instead of permanent delete
    - [ ] "Empty Trash" option
    - [ ] Restore from trash
    - [ ] Shift+Delete for permanent delete
    - [ ] Platform-specific trash locations:
      - macOS: ~/.Trash
      - Linux: ~/.local/share/Trash (freedesktop spec)
      - Windows: Recycle Bin API

*** TODO Column Headers and Sorting
    Priority: MEDIUM
    - [ ] Clickable column headers (Name, Size, Date, Type)
    - [ ] Sort indicator (arrow up/down)
    - [ ] Column resizing by dragging borders
    - [ ] Column reordering by dragging headers
    - [ ] Remember column widths per directory (stretch goal)

*** TODO File Properties Dialog
    Priority: MEDIUM
    - [ ] Show file/folder metadata:
      - Size (and size on disk)
      - Location
      - Created/Modified/Accessed dates
      - Permissions (with edit on Unix)
      - Type/MIME type
    - [ ] Keyboard shortcut: Ctrl/Cmd+I or Alt+Enter
    - [ ] Multiple selection shows combined size

*** TODO Keyboard Navigation
    Priority: MEDIUM
    - [ ] Arrow keys to move selection
    - [ ] Enter to open file/folder
    - [ ] Backspace to go up one level
    - [ ] Type-to-select (type filename to jump to it)
    - [ ] Space bar for Quick Look preview
    - [ ] Tab to cycle focus between panels

** Tier 2: Expected by Users

*** TODO Grid/Icon View
    - [ ] Toggle between list and grid view
    - [ ] Thumbnail previews for images
    - [ ] Configurable icon/thumbnail size
    - [ ] View menu or toolbar toggle

*** TODO Archive/Compression Support
    - [ ] Open zip/tar/gz as virtual folder
    - [ ] Extract archive (right-click menu)
    - [ ] Create archive from selection (right-click menu)
    - [ ] Supported formats: zip, tar, tar.gz, tar.bz2, 7z (stretch)

*** TODO Quick Look (Space Bar Preview)
    - [ ] Space bar opens preview overlay
    - [ ] Escape or Space again to close
    - [ ] Arrow keys to navigate while preview open
    - [ ] Full-size preview vs current panel preview

*** TODO Selection Info in Status Bar
    - [ ] Show "X items selected"
    - [ ] Show combined size of selection
    - [ ] Show free space on current drive

** Tier 3: Competitive Differentiators

*** TODO Quick Actions / Batch Operations
    - [ ] Batch rename with patterns
    - [ ] Batch convert images
    - [ ] Custom quick actions (user scripts)

*** TODO Tags and Labels
    - [ ] Color-coded labels (like Finder)
    - [ ] Custom text tags
    - [ ] Filter by tag
    - [ ] Tags stored in extended attributes or sidecar DB

*** TODO Smart Folders / Saved Searches
    - [ ] Save search criteria as virtual folder
    - [ ] Smart folders in sidebar
    - [ ] Real-time updates

*** TODO Terminal Integration
    - [ ] "Open Terminal Here" context menu
    - [ ] Embedded terminal panel (toggle)
    - [ ] Configurable terminal app

* Completed Features

** DONE Config.json for UI/Settings Configuration
   CLOSED: [2024-11-30]
   - [X] Created internal/config package
   - [X] Config file at ~/.config/razor/config.json
   - [X] Theme, sidebar layout, search settings, preview config
   - [X] Favorites stored in config.json (not SQLite)
   - [X] Hot-reload not implemented (restart required)

** DONE Composable Sidebar UI
   CLOSED: [2024-11-30]
   - [X] Tabbed view (Favorites | Drives tabs)
   - [X] Stacked view option
   - [X] Tab style options (manila, underline, pill)
   - [X] Layout configurable via config.json

** DONE Search History (SQLite)
   CLOSED: [2024-11-30]
   - [X] Store past search queries with timestamps
   - [X] Auto-complete dropdown from search history
   - [X] Fuzzy matching for history suggestions
   - [X] Prune old entries (keeps last 100)

** DONE Recent Files/Directories (SQLite)
   CLOSED: [2024-11-30]
   - [X] Track recently opened files and directories
   - [X] "Recent Files" virtual folder accessible from sidebar
   - [X] Last 50 files tracked and displayed
   - [X] "Open File Location" context menu option
   - [X] Stale files filtered out automatically

** DONE File Preview Panel
   CLOSED: [2024-11-30]
   - [X] Text file preview with scrolling
   - [X] Image preview (PNG, JPG, GIF, BMP, WebP, HEIC)
   - [X] Images scaled to fit preview pane
   - [X] Resizable preview pane with drag handle
   - [X] File size limits (configurable)
   - [ ] File metadata display (not implemented)

** DONE Orchestrator Refactor
   CLOSED: [2024-11-30]
   - [X] Split into SearchController and NavigationController
   - [X] SharedDeps and SharedState for clean dependency sharing
   - [X] Orchestrator remains wiring layer
   - [X] Created separate file_ops.go for file operations

** DONE Code Deduplication Refactor
   CLOSED: [2024-11-30]
   - [X] pathExists(), deleteItem(), refreshCurrentDir() utilities
   - [X] resetUIState() helper for navigation handlers
   - [X] Search directive constants extracted
   - [X] Config manager lock pattern fixed
   - [X] File permission and time duration constants

** DONE Right-Click Context Menu
   CLOSED: [2024-11-29]
   - [X] Right-click on files shows context menu
   - [X] Right-click on empty space shows background menu (New File/Folder)
   - [X] Right-click on favorites shows favorite-specific menu
   - [X] Left-click anywhere dismisses menu

** DONE Background Right-Click Menu
   CLOSED: [2024-11-29]
   - [X] Right-click on empty space in file list shows context menu
   - [X] Background menu shows: New File, New Folder, Paste (if clipboard has content)
   - [X] Works in empty directories

** DONE Path Navigation Bug Fix
   CLOSED: [2024-11-29]
   - [X] Handle ~ for home directory
   - [X] Handle ~/path tilde expansion
   - [X] Handle absolute Unix paths (/usr/bin)
   - [X] Handle relative paths (../, ./)
   - [X] Handle Windows drive letters (C:\, D:\)
   - [X] Handle UNC paths (\\server\share)
   - [X] Validate paths before navigation

** DONE Create New File/Folder Dialog
   CLOSED: [2024-11-29]
   - [X] Add "New File" to right-click context menu
   - [X] Add "New Folder" to right-click context menu
   - [X] Keyboard shortcuts (Ctrl+N file, Ctrl+Shift+N folder)
   - [X] Modal dialog with text input
   - [X] Validation (prevent duplicates)
   - [X] Refresh directory after creation

** DONE Open With Support
   CLOSED: [2024-11-29]
   - [X] Linux: xdg-open, kde-open5, gio support
   - [X] macOS: open command, Finder reveal
   - [X] Windows: ShellExecuteW, rundll32 OpenAs_RunDLL
   - [X] Add "Open With..." to context menu (files only)

** DONE Search Improvements
   CLOSED: [2024-11-29]
   - [X] Search-as-you-type for simple filename searches
   - [X] Directives (contents:, ext:, size:, modified:, filename:) require Enter
   - [X] Clear button (X) appears when search active
   - [X] Visual directive pills with color coding
   - [X] Generation counter prevents stale results
   - [X] Search cancellation support
   - [X] recursive: and depth: directives for deep search
   - [X] Progress bar updates during search
   - [X] Binary file detection (skip files with null bytes)

** DONE Search Engine Integration
   CLOSED: [2024-11-29]
   - [X] Detect available search engines (ripgrep, ugrep)
   - [X] Settings dropdown shows installed engines with versions
   - [X] ripgrep and ugrep integration for contents: searches
   - [X] Engine selection persisted in config.json

** DONE Rename File/Folder
   CLOSED: [2024-11-29]
   - [X] Add "Rename" to context menu
   - [X] Inline editing in file list
   - [X] Keyboard shortcut (F2)
   - [X] Only filename selected (not extension) for files
   - [X] Validation (prevent duplicates)

** DONE Theme Settings
   CLOSED: [2024-11-29]
   - [X] Light/Dark theme toggle in settings
   - [X] Theme preference saved to config.json
   - [X] Theme applied on startup

** DONE Navigation button styling
   - [X] Icon-only buttons for back/forward/home
   - [X] Programmatic icon drawing with clip.Path

* Other Planned Features

** DONE Browser Tabs
   CLOSED: [2024-11-30]
   - [X] Tab bar for multiple directories (appears when 2+ tabs)
   - [X] File menu -> New Tab
   - [X] Close tab (X button)
   - [X] Tab state preservation (path, history, selection)
   - [X] Configurable new tab location (home, current, recent, custom path)
   - [X] "Open in New Tab" context menu for folders
   - [ ] Ctrl+T / Ctrl+W keyboard shortcuts (not yet implemented)
   - [ ] Drag tabs to reorder (not yet implemented)

** TODO Favorites Management
*** TODO Favorites Folders (Dropdown Groups)
    - [ ] Create "Favorites Group" data structure
    - [ ] Collapsible group headers in sidebar
    - [ ] Drag favorites into groups

** TODO Column View (macOS Finder style)
   - [ ] Multi-column navigation
   - [ ] Each column shows contents of selected folder
   - [ ] Horizontal scrolling for deep hierarchies

** TODO Vim-style Navigation (Optional Mode)
   - [ ] hjkl for movement
   - [ ] / for search
   - [ ] dd for delete
   - [ ] yy/p for copy/paste
   - [ ] Configurable in settings

** TODO Customizable Keyboard Shortcuts
   - [ ] Settings UI to rebind shortcuts
   - [ ] Import/export shortcut configs
   - [ ] Preset profiles (Default, Vim, Emacs)

** TODO Network/Remote Access
   - [ ] SFTP connection support
   - [ ] SMB/CIFS network shares
   - [ ] FTP connection support
   - [ ] WebDAV support
   - [ ] Bookmarked remote locations in sidebar

* Known Issues / Technical Debt

** TODO Context menu positioning
   - Menu can appear off-screen near edges
   - Consider using system-level popup windows

** TODO Large directory performance
   - Directories with 10k+ files can be slow
   - Consider virtualized list

** TODO Dialog text input focus
   - Create New File/Folder dialog doesn't auto-focus the text input
   - User has to click in the textbox before typing

** TODO Error Handling
   - [ ] User-friendly error messages (toast notifications)
   - [ ] Error notification system
   - [ ] Logging improvements
